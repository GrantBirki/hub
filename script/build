#!/usr/bin/env bash
# Usage: script/build [-o output] [test]
#
# Sets up GOPATH and compiles hub. With `test`, runs tests instead.

set -e

setup_gopath() {
  TMP_GOPATH="${TMPDIR:-/tmp}/go"
  TMP_SELF="${TMP_GOPATH}/src/github.com/github/hub"

  export GOPATH=${TMP_GOPATH}
  if [ "$OSTYPE" == "cygwin" ]; then
    # converts *nix path to Windows path which Go expects on Windows
    GOPATH=$(cygpath -w $GOPATH)
  fi

  if [ ! -e "$TMP_SELF" ]; then
    mkdir -p "${TMP_SELF%/*}"
    cp -R "$PWD" "$TMP_SELF"
  fi
}

build_hub() {
  setup_gopath
  if [ ! -z $1 ]; then
    OUTPUT="-o $1"
  fi
  go build -ldflags "-X github.com/github/hub/commands.Version `./script/version`" $OUTPUT
}

test_hub() {
  setup_gopath
  go test ./...
}

case "$1" in
  "" )
    build_hub
    ;;
  -o )
    shift
    build_hub $1
    ;;
  test )
    test_hub
    ;;
  -h | --help )
    sed -ne '/^#/!q;s/.\{1,2\}//;1d;p' < "$0"
    exit
    ;;
  * )
    "$0" --help >&2
    exit 1
esac
